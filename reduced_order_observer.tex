\documentclass[letterpaper,11pt]{article}
\usepackage[margin=1in,centering]{geometry}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[
    abbreviate=false,
    backend=biber,
    backref=true,
    sortcites=true,
    sorting=nyt,
    sortlocale=en_US,
    maxnames=10,
    style=numeric-verb
]{biblatex}
\addbibresource{library.bib}
\usepackage{siunitx}
\usepackage{pgfplots}
\pgfplotsset{
  compat=newest,
  compat/show suggested version=false,
  every axis legend/.append style={
    draw=none
  },
  every axis/.append style={
    no markers,
    enlargelimits=false,
    grid=major
  }
}
\usepackage[
    colorlinks=true,
    pdfencoding=auto,
    pdftitle={Bicycle reduced order observer},
    pdfauthor={Dale L. Peterson, Oliver Z. Lee, Mont Hubbard },
    pdfsubject={Bicycle roll angle estimation},
    pdfkeywords={bicycle, dynamics, control}
    xetex
]{hyperref}

\begin{document}
\title{Implementation and design of a bicycle state estimator}
\author{Dale L. Peterson, Oliver Z. Lee, Mont Hubbard}
\date{\today}
\maketitle

\begin{abstract}
This paper presents two approaches for estimating bicycle state; 1) a
reduced-state estimator and 2) a full-state estimator. Experimental results
obtained on a robotic bicycle are presented for the full-state estimator;
discussion of the reduced-state estimator is limited to a theoretical
framework. In both cases, the plant is taken to be the Whipple bicycle model
linearized about the zero lean, zero steer configuration with a constant
forward speed.  We also breifly discuss how the speed dependent dynamics were
accounted for in the implementation of the robotic bicycle.
\end{abstract}

\section{Introduction} \label{sec:introduction}
A frequent requirement in control system design is knowledge of the state of
the plant to be controlled. If the plant is observable through the available
measurements, the state estimates $\hat{x}$ can be used in place of the true
states $x$ when applying the feedback control law (i.e., $u=K\hat{x}$ instead
of $u=Kx$). Alternatively, if some states are directly measurable, it is
possible to design a reduced order estimator~\cite{Bryson1970} with fewer
states than that of the plant (a full order observer has the same number of
states as the plant).  Reduced-state estimators typically have higher bandwidth
but do not filter the measurements of the state so they are more susceptible to
measurement noise.  From a control system implementation perspective,
reduced-state estimators can have lower computational cost and therefore be
attractive in applications with constrained computational capabilities or with
stringent bandwidth requirements.

The four states in the linearized state space equations of the Whipple bicycle
model are lean $\phi$, steer $\delta$, lean rate $\dot{\phi}$, steer rate
$\dot{\delta}$.  Of these, the most difficult to measure directly $\phi$.
Techniques to measure or estimate $\phi$ include optical sensors on both sides
of the rear wheel axle to measure the distance from the axle to the ground,
mechanical trailers measuring lean with a potentiometer or encoder, and IMU
based solutions which employ rate gyroscopes and/or accelerometers and Kalman
filtering techniques to obtain orientation estimates\cite{Boniolo2008}.

We constructed a robotic bicycle to conduct system identification experiments,
without a human rider, for the purpose of experimentally validating the Whipple
bicycle model. This required the implementation of a stabilizing state feedback
controller and by extension, a state estimator. The bicycle was equipped with
optical encoders to measure $\delta$ and the wheel angles $\theta_r$ and
$\theta_f$; the rear wheel angle measurement was differentiated numerically to
obtain the wheel rate (and hence, the forward speed). A MEMS rate gyroscope
fixed to the rear bicycle frame was used to measure roll rate $\dot{\phi}$. The
bicycle was also equipped with a rear hub motor to control the speed and a
steer motor to turn the fork relative to the frame (and hence balance the
bicycle). Using state space matrices determined from measurements of bicycle
physical parameters and the presumed Whipple model, we designed a gain
scheduled LQR controller which assumes full state feedback. We omit the details
of the LQR gain selection, and focus instead on the design of the state
estimator.

This paper is organized as follows. \hyperref[sec:methods]{Section 2} describes
the design of the reduced-state and full-state estimators.
\hyperref[sec:results]{Section 3} presents results obtained for the full-state
estimator for a single run of the robotic bicycle at \SI{2.0}{\m\per\s}. We
discuss the estimator performance in \hyperref[sec:discussion]{Section 4} and
summarize our findings as well as give thoughts for future work in
\hyperref[sec:conclusion]{Section 5}.

\section{Methods} \label{sec:methods}
\subsection{Reduced-state estimator} \label{reducedstate}
With the bicycle state $x = \left[\phi, \delta, \dot{\phi},
\dot{\delta}\right]^T$, input steer torque $T_\delta$, and measurements $z =
[\delta, \dot{\phi}, \dot{\delta}]^T$,
the linear state space bicycle equations are of the form:
\begin{equation*}
\dot{x} =\left[\begin{smallmatrix}0 & 0 & 1 & 0\\0 & 0 & 0 & 1\\a_{20} & a_{21} &
a_{22} & a_{23}\\a_{30} & a_{31} & a_{32} & a_{33}\end{smallmatrix}\right] x +
\left[\begin{smallmatrix}0\\0\\b_{20}\\b_{30}\end{smallmatrix}\right] T_\delta
\qquad
z = \left[\begin{smallmatrix}0 & 1 & 0 & 0\\ 0 & 0 & 1 & 0\\ 0 & 0 & 0 &
1\end{smallmatrix}\right] x
\end{equation*}
Where we have assumed we can directly measure steer $\delta$, roll rate
$\dot{\phi}$, and steer rate $\dot{\delta}$.  It is worth noting that the
$a_{20}$ and $a_{30}$ entries of the system dynamics matrix are independent of
forward speed, $a_{21}$ and $a_{31}$ depend on the square of forward speed, and
the remaining $a_{ij}$ depend linearly on forward speed.  Following
\cite{Bryson1970}, we introduce a change of variables
\begin{align*}
\left[\begin{smallmatrix}w \\ z\end{smallmatrix}\right] &=
\left[\begin{smallmatrix}k_0 & k_1 & k_2 & k_3 \\ 0 & 1 & 0 & 0\\ 0 & 0 & 1 & 0\\ 0 & 0 & 0 &
1\end{smallmatrix}\right] x  \quad\implies\quad
x =
\left[\begin{smallmatrix}\frac{1}{k_{0}} & - \frac{k_{1}}{k_{0}} & -
  \frac{k_{2}}{k_{0}} & - \frac{k_{3}}{k_{0}}\\0 & 1 & 0 & 0\\0 & 0 & 1 & 0\\0
  & 0 & 0 & 1\end{smallmatrix}\right]\left[\begin{smallmatrix} w \\ z\end{smallmatrix}\right]
\end{align*}
where $k_0\ne0$.  From this change of variables, an observer for $w$ can be
synthesized as
\begin{align*}
\dot{\hat{w}} &= \frac{a_{20} k_{2} + a_{30} k_{3}}{k_{0}} \hat{w}
 + \left(a_{21} k_{2} + a_{31} k_{3} - \frac{k_{1} \left(a_{20} k_{2} + a_{30} k_{3}\right)}{k_{0}}\right) \delta \\
 &+ \left(a_{22} k_{2} + a_{32} k_{3} + k_{0} - \frac{k_{2} \left(a_{20} k_{2} + a_{30} k_{3}\right)}{k_{0}}\right) \dot{\phi}
 + \left(a_{23} k_{2} + a_{33} k_{3} + k_{1} - \frac{k_{3} \left(a_{20} k_{2} + a_{30} k_{3}\right)}{k_{0}}\right) \dot{\delta} \\
 &+ \left(b_{20} k_{2} + b_{30} k_{3}\right) T_\delta
\end{align*}

To stabilize the observer state equation we must choose $k_0, k_2, k_3$ such
that
\begin{equation*}
\frac{a_{20} k_{2} + a_{30} k_{3}}{k_{0}} < 0
\end{equation*}

The selection of $k_0$, $k_2$, and $k_3$, is guided by the control systems
design principle which suggests that observer poles be placed 3-10 times faster
than the fastest pole of the controlled plant. Since $a_{20}$ and $a_{30}$ are
independent of speed, the estimator eigenvalues can be arbitrarily assigned by
selection of fixed $k_0$, $k_2$, and $k_3$ that are independent of speed.

The selection of the $k_i's$ can be performed using several techniques, but all
techniques essentially distill down to how the plant model (and the associated
measurements of its physical) is trusted in comparison to the state
measurements.

%In the full paper to be submitted, we describe in detail the
%design procedure of selecting the $k_i's$ to yield a roll angle observer with
%good performance characteristics and desirable noise rejection.  We present
%experiments of a robot bicycle with an implementation of this reduced order
%observer to estimate roll $\phi$ and use the estimated roll and state
%measurements to perform real time estimation and feedback control. Design
%considerations and directions for future refinements are also presented.
%
%However, the coefficients which multiply the measured states $z$ and the known
%input $T_\delta$ do depend upon speed.  meausured states $z = [\delta$ and the
%plant input .  Beyond this essential stability property, it is not entirely
%clear to me how the entries of $K$ should be selected to determine the
%coefficients that multiply the state measurements and steer torque
%input.

\subsection{Full-state estimator}


\section{Results} \label{sec:results}
\begin{figure}
  \pgfplotsset{set layers}
  \pgfplotstableread{data/000_time_series_data_t20_t30-decimated.txt}\runzero
  \centering
  \begin{tikzpicture}
    \begin{axis}[
      y axis style/.style={
      yticklabel style=#1,
      ylabel style=#1,
      y axis line style=#1,
      ytick style=#1
      },
      scale only axis,
      axis y line*=left,
      axis x line*=bottom,
      xlabel=Time (\si{\s}),
      ylabel=\si{\m\per\s},
      y axis style=red!75!black
    ]
    \addplot[red] table[x=time, y=v]{\runzero}; \label{measured_v}
    \addplot[blue] table[x=time, y=v_c]{\runzero}; \label{commanded_v}
    \end{axis}
  \end{tikzpicture}
  \caption{test}
  \label{rb:fig:run000a}
\end{figure}

\section{Discussion} \label{sec:discussion}

\section{Conclusion} \label{sec:conclusion}

\printbibliography

\end{document}

